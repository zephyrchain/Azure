Hyper-V Study Guide 

1. Introduction to Hyper-V
â€¢	Definition: Hyper-V is Microsoft's hypervisor, introduced with Windows Server 2008.
â€¢	Significance: It enables virtualization by allowing multiple virtual machines (VMs) to run on a single physical host.
â€¢	Type: Type 1 hypervisor, meaning it runs directly on the hardware (bare-metal).
â€¢	Usage: Used in Azure, Azure Stack, and Windows Server environments.

2. Physical Host Resources
â€¢	Components: 
o	CPU: Performs computational tasks.
o	Memory: RAM allocated to VMs.
o	Network Interface Cards (NICs): Connect to networks, possibly segmented via VLANs.
o	Storage: Local or external (SAN via iSCSI/Fiber Channel, NAS via SMB).
o	GPU: Important for tasks like machine learning.
â€¢	Virtualization Benefit: Avoids resource waste by allowing multiple VMs on a single host.

3. Virtual Machines Overview
â€¢	Creation: Multiple VMs can be created on a single physical host.
â€¢	Resource Allocation: Each VM gets a portion of the host's CPU, memory, network, and storage.
â€¢	Isolation: VMs are completely isolated at the kernel mode level, ensuring security and stability.

4. The Hypervisor
â€¢	Role: Manages and allocates physical resources (CPU, memory) to VMs.
â€¢	Type: Type 1 hypervisor, running directly on hardware.
â€¢	Hardware Support: Requires hardware-assisted virtualization (Intel VT, AMD-V) and features like Second Level Address Translation (SLAT).

5. Management Partition
â€¢	Parent Partition: The original host OS becomes the management partition after enabling Hyper-V.
â€¢	Driver Handling: Manages drivers for network, storage, and GPU resources on behalf of VMs.
â€¢	Security: Micr-kernelized architecture separates driver management from the hypervisor for added security.

6. VMBus Communication
â€¢	VMBus: A kernel-mode, in-memory bus that facilitates communication between VMs and the parent partition.
â€¢	Components: 
o	Virtual Service Consumer (VSC): Resides in VMs.
o	Virtual Service Provider (VSP): Resides in the parent partition, communicates with the I/O stack and drivers.

7. CPU Rings and Hyper-V
â€¢	CPU Rings: 
o	Ring 0: Kernel mode (OS operations).
o	Ring 3: User mode (applications).
o	Ring -1: Hypervisor operations, allowing the hypervisor to manage VMs without interfering with guest OS operations.

8. VM Management Processes
â€¢	Virtual Machine Management Service (VMMS): Runs in the parent partition to manage VMs.
â€¢	VM Worker Process: Each VM has a dedicated process to monitor its state and manage operations like start/stop.
â€¢	Reboot Impact: Rebooting the parent partition requires shutting down or saving the state of VMs, as they rely on the parent for storage and network connectivity.

9. Azure and Hyper-V
â€¢	Usage in Azure: Azure uses Hyper-V as its hypervisor.
â€¢	Management Differences: Azure implements features like VM Fu (Virtual Machine Preserving Host Update) to maintain VMs during host updates.
â€¢	Innovations: Features like GPU partitioning in Windows Server 2025 may eventually be integrated into Azure.

10. Synthetic vs. Emulated Hardware
â€¢	Enlightened OSs: Modern OSs understand they are running in a VM and use synthetic drivers for better performance.
â€¢	Emulated Hardware: Older or Gen 1 VMs may use emulated hardware (e.g., IDE controller, legacy NIC), which can impact performance.
â€¢	Performance: Synthetic drivers offer near-native performance, while emulated hardware incurs overhead.

11. Generations of VMs
â€¢	Gen 1 VMs: 
o	BIOS-based.
o	Boot from IDE controller.
o	Use legacy NIC.
â€¢	Gen 2 VMs: 
o	UEFI-based.
o	Boot from SCSI controller.
o	Support secure boot and virtual TPM.
o	Better performance due to synthetic hardware.
â€¢	Conversion: Difficult due to different disk structures and drivers.

12. CPU Resource Allocation and Scalability
â€¢	Physical CPU Structure: 
o	Sockets: Physical CPU units.
o	Cores: Processing units within a socket.
o	Hyperthreading: Allows multiple threads per core, increasing logical processors.
â€¢	Virtual CPUs (vCPUs): Allocated to VMs, with the ability to overcommit (allocate more vCPUs than physical CPUs).
â€¢	Dynamic Allocation: Hypervisor dynamically allocates CPU cycles to VMs based on demand.
â€¢	Scalability Limits: 
o	Host: Up to 248 logical processors and 4 PB of RAM.
o	VM: Up to 2048 vCPUs and 240 TB of RAM.

13. vCPU Configurations
â€¢	Static Allocation: Number of vCPUs cannot be changed while the VM is running.
â€¢	Reserve: Guarantees a minimum percentage of CPU capacity.
â€¢	Limit: Restricts the VM to a maximum percentage of CPU usage.
â€¢	Relative Weight: Prioritizes CPU allocation during contention (e.g., higher weight for a SQL server VM compared to a domain controller).

14. Core Scheduler
â€¢	Introduction: Introduced in Windows Server 2016 as the default scheduler in Windows Server 2019 and above.
â€¢	Functionality: 
o	Prevents side-channel attacks by ensuring processes from different VMs are not scheduled on the same core.
o	Event ID 2 in Event Viewer confirms the use of the core scheduler (type 3).

15. Processor Compatibility
â€¢	Compatibility Mode: Dumbs down the processor to a basic instruction set to enable live migration between different processor models (Intel to Intel or AMD to AMD only).
â€¢	Dynamic Compatibility Mode: Available in failover clusters, dumbs down to the lowest common denominator among cluster nodes.
â€¢	Configuration: Set in Hyper-V Manager or via PowerShell.

16. NUMA Configuration
â€¢	Non-Uniform Memory Access (NUMA): Memory access times differ based on proximity to the processor socket.
â€¢	NUMA Spanning: Enabled by default, allows memory allocation across different NUMA nodes for better VM density (with a minor performance penalty).

17. Memory Management
â€¢	Dynamic Memory: 
o	Minimum/Maximum: Sets bounds for memory allocation.
o	Starting Memory: Initial allocation at VM startup.
o	Buffer: Maintains a percentage of unused memory within the VM.
o	Weight: Prioritizes memory allocation among VMs.
â€¢	Runtime Memory Resize: 
o	Manual adjustment of memory allocation while the VM is running.
o	Supported on Windows 10/Server 2016 and above, and Linux with hot-add capability.
â€¢	Balloon Driver: 
o	Mechanism to reclaim memory by inflating a driver within the guest OS, effectively reserving pages for the hypervisor to reallocate.

18. Networking
â€¢	Virtual Network Interfaces: 
o	Synthetic network adapter (recommended for performance).
o	Legacy emulated network adapter (for compatibility with older OSs).
â€¢	Virtual Switch Types: 
o	External: Connects VMs to physical NICs for external network access.
o	Internal: Enables communication between VMs and the host, without external access.
o	Private: Isolates VMs on the same host, with no host or external access.
â€¢	Advanced Features: 
o	VLAN support for network segmentation.
o	Bandwidth management to set minimum and maximum limits.
o	VMQ (Virtual Machine Queue) for distributing network traffic across multiple cores.
o	SR-IOV (Single Root I/O Virtualization) for direct hardware access and low latency.
o	Security features like MAC address spoofing and DHCP guard.

19. Storage
â€¢	VHDX Formats: 
o	Dynamic: Expands as data is written, saving initial storage space.
o	Fixed: Pre-allocates the entire disk space upfront for consistent performance.
o	Differencing: Tracks changes from a parent disk, useful for creating multiple similar VMs (e.g., VDI environments).
â€¢	Storage Locations: 
o	Local storage (not recommended for clustered environments).
o	Storage Spaces Direct (hyper-converged infrastructure).
o	SAN (Storage Area Network) via iSCSI or Fiber Channel.
o	SMB3 file shares for network-attached storage.
â€¢	Advanced Storage Features: 
o	Virtual Fiber Channel: Maps physical HBAs (Host Bus Adapters) into VMs for direct SAN access.
o	Shared VHDX: Allows multiple VMs to access the same disk (e.g., for clustering).
o	Live Storage Migration: Moves storage between locations without downtime by copying data and syncing changes before switching paths.

20. Live Migration
â€¢	Purpose: Moves running VMs between hosts with minimal downtime (used for maintenance, load balancing, or failure recovery).
â€¢	Process: 
1.	Copies memory and state from source to destination host.
2.	Tracks and re-copies dirty pages (changed during the initial copy).
3.	Pauses the VM briefly to transfer the final state and CPU context.
4.	Resumes the VM on the destination host and redirects clients.
â€¢	Configuration Options: 
o	Concurrent migrations (limit based on network capacity).
o	Dedicated network for live migration traffic.
o	Combined live migration and storage migration for "shared nothing" scenarios (moves VM and its storage simultaneously).

21. Management Tools
â€¢	Hyper-V Manager: 
o	Basic GUI tool for small-scale environments.
o	Can manage multiple hosts but lacks advanced features.
â€¢	PowerShell: 
o	Scripting and automation for Hyper-V management tasks.
â€¢	Windows Admin Center: 
o	Free, web-based tool for managing Hyper-V hosts and clusters.
o	Provides a modern interface and integrates with other Windows Server features.
â€¢	System Center Virtual Machine Manager (SCVMM): 
o	Enterprise-grade management solution for large Hyper-V deployments.
o	Features include templating, service deployment, and advanced monitoring.
â€¢	Azure Arc: 
o	Extends Azure management capabilities to on-premises Hyper-V environments.
o	Enables hybrid cloud scenarios with unified governance and monitoring.

22. Licensing
â€¢	Windows Server Licensing: 
o	Hyper-V is included with Windows Server licenses (per core).
o	Most customers already own the necessary licenses.
â€¢	Azure Stack HCI: 
o	Subscription-based model for hyper-converged infrastructure solutions.
o	Includes Hyper-V as part of the package.
â€¢	Historical Option: 
o	Previously, Microsoft offered a free Hyper-V Server product for specific use cases (e.g., Linux VMs or VDI), but this has been deprecated in favor of the above licensing models.

23. Summary
â€¢	Hyper-V is a robust, enterprise-grade Type 1 hypervisor comparable to VMware or KVM.
â€¢	Key strengths include: 
o	Advanced memory and CPU management (dynamic allocation, core scheduling).
o	Comprehensive networking and storage options.
o	Seamless mobility features (live migration, storage migration).
o	Broad guest OS support (Windows and Linux).
o	Integration with Azure for hybrid cloud scenarios.
â€¢	Ideal for both on-premises virtualization and cloud-based deployments via Azure Stack HCI.

ðŸ“º Reference
Savill, J.â€¯(2024,â€¯Decemberâ€¯9). Hyperâ€‘V Overview [Video]. YouTube. https://www.youtube.com/watch?v=CqgsJzn3uXM

Stay virtual. Stay versatile. Let your workloads live their best (virtual) life. ðŸš€
